<div class="card w-full h-2/3 bg-base-100 flex flex-col justify-center items-center shadow-lg border border-base-300">
 <div class="card-title text-center pt-4 text-lg font-semibold">Przychody miesięczne</div>
 <div class="card-body w-full px-6">
   <canvas id="monthlyRevenueChart" width="400" height="200"></canvas>
 </div>
</div>

<!-- Additional info -->
<div class="top-right-bottom flex gap-8 mt-8 h-1/3">
 <!-- Karta miesięcznych przychodów -->
 <div class="card w-1/2 bg-base-100 shadow-lg border border-base-300 flex flex-col justify-center items-center">
   <div class="card-title text-center pt-4 text-lg font-semibold">Przychody miesięczne</div>
   <div class="card-body p-6 text-primary text-center font-bold text-4xl">
     {{ monthly_revenue }}
   </div>
 </div>

 <!-- Karta rocznych przychodów -->
 <div class="card w-1/2 bg-base-100 shadow-lg border border-base-300 flex flex-col justify-center items-center">
   <div class="card-title text-center pt-4 text-lg font-semibold">Przychody roczne</div>
   <div class="card-body p-6 text-accent text-center font-bold text-4xl">
     {{ yearly_revenue }}
   </div>
 </div>
</div>



<script>
    (function() {
        // Dane do wykresu
        let rawData = '{{ monthly_revenues|escapejs }}';
        let monthlyData = [];
        try {
            const parsed = JSON.parse(rawData);
            if (Array.isArray(parsed)) monthlyData = parsed;
            else if (typeof parsed === 'object' && parsed !== null) monthlyData = Object.values(parsed);
        } catch (e) { console.error("Data parse error", e); }

        const chartId = 'monthlyRevenueChart';

        // Funkcja inicjalizująca wykres (uruchomimy ją, gdy biblioteka będzie gotowa)
        function initChart() {
            const existingChart = Chart.getChart(chartId);
            if (existingChart) existingChart.destroy();

            const ctx = document.getElementById(chartId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
                        'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
                    ],
                    datasets: [{
                        label: "",
                        data: monthlyData,
                        backgroundColor: 'oklch(0.819 0.111 230.462)',
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // SPRAWDZANIE DOSTĘPNOŚCI CHART.JS
        if (typeof Chart !== 'undefined') {
            // Biblioteka jest już załadowana (np. z cache przeglądarki lub innego partiala)
            initChart();
        } else {
            // Biblioteki nie ma, musimy ją załadować
            // Sprawdzamy czy skrypt już się ładuje (żeby nie dodawać go 2 razy)
            const scriptSrc = "https://cdn.jsdelivr.net/npm/chart.js";
            let script = document.querySelector(`script[src="${scriptSrc}"]`);

            if (!script) {
                script = document.createElement('script');
                script.src = scriptSrc;
                script.onload = initChart; // Uruchom initChart po załadowaniu
                document.head.appendChild(script);
            } else {
                // Skrypt jest w trakcie ładowania (np. przez inny request), podpinamy się pod onload
                const originalOnLoad = script.onload;
                script.onload = function() {
                    if (originalOnLoad) originalOnLoad();
                    initChart();
                }
            }
        }
    })();
</script>
