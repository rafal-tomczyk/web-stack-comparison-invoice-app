{% extends "frontend_templates/base.html" %}

{% block title %}Dodaj Fakturę{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h2 class="text-3xl font-bold">Faktury</h2>
  <a href="{% url 'tmp_invoices' %}" class="btn btn-error btn-md shadow-md">
    Wróć do listy faktur
  </a>
</div>

<div class="card bg-base-100 shadow-lg border border-base-300 rounded-box p-6">
  <h2 class="text-2xl font-bold mb-4">Dodaj nową fakturę</h2>
  <form method="POST" class="space-y-4">
    {% csrf_token %}
    {{ form.as_table }}

    {{ item_formset.management_form }}

    {% if item_formset.non_form_errors %}
      <div class="alert alert-error my-2">
        {{ item_formset.non_form_errors }}
      </div>
    {% endif %}

    <table class="table w-full">
      <thead>
        <tr>
          <th>Produkt</th>
          <th>Ilość</th>
          <th>Cena netto</th>
          <th>VAT</th>
          <th>Usuń</th>
        </tr>
      </thead>
      <tbody id="items-table">
        {% for form in item_formset %}
        <tr class="item-form">
          <td>{{ form.product }}</td>
          <td>{{ form.quantity }}</td>
          <td>{{ form.net_price }}</td>
          <td>{{ form.tax_rate }}</td>
           <td>
              <!-- Ukrywamy checkbox DELETE za pomocą klasy CSS 'hidden' -->
              <div class="hidden">
                {{ form.DELETE }}
              </div>

              <!-- Jeśli formularz nie ma pola DELETE w 'hidden' (np. przy nowych wierszach),
                   JS sam obsłuży logikę przez pole ukryte -->
              {% if not form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-DELETE" id="id_{{ form.prefix }}-DELETE" />
              {% endif %}

              <button type="button" class="btn btn-sm btn-error delete-row">
                Usuń
              </button>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button"
      id="add-row"
      class="btn btn-outline btn-primary mt-4">
      Dodaj pozycję
    </button>
    <button type="submit" class="btn btn-primary">Zapisz fakturę</button>
  </form>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
      const addRowBtn = document.getElementById("add-row");
      const itemsTable = document.getElementById("items-table");
      const totalFormsInput = document.getElementById("id_items-TOTAL_FORMS");

      addRowBtn.addEventListener("click", function () {
          const currentForms = parseInt(totalFormsInput.value);
          const newFormIndex = currentForms;

          // Pobierz pierwszy formularz jako wzór
          const rows = document.querySelectorAll(".item-form");
          if (rows.length === 0) return;

          const emptyForm = rows[0].cloneNode(true);
          emptyForm.style.display = "";

          emptyForm.querySelectorAll("input, select, textarea").forEach((field) => {
              const name = field.getAttribute("name");
              const id = field.getAttribute("id");

              if (name) {
                  field.setAttribute("name", name.replace(/items-(\d+)-/, `items-${newFormIndex}-`));
              }
              if (id) {
                  field.setAttribute("id", id.replace(/items-(\d+)-/, `items-${newFormIndex}-`));
              }

              if (field.tagName === "SELECT" && field.hasAttribute('data-listener-attached')) {
                  field.removeAttribute('data-listener-attached');
              }

              if (field.tagName === "SELECT") {
                  field.selectedIndex = 0;
              } else if (field.type === "checkbox") {
                  field.checked = false;
              } else {
                  // Jeśli to pole ilości, ustaw 1, inaczej pusty string
                  field.value = name && name.includes("quantity") ? "1" : "";
              }
          });

          const deleteBtn = emptyForm.querySelector(".delete-row");
          if (deleteBtn) {
              deleteBtn.addEventListener("click", function () {
                  const row = this.closest("tr");
                  const delCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                  const delHidden = row.querySelector('input[type="hidden"][name$="-DELETE"]');
                  if (delCheckbox) delCheckbox.checked = true;
                  if (delHidden) delHidden.value = "on";
                  row.style.display = "none";
              });
          }

          itemsTable.appendChild(emptyForm);
          totalFormsInput.value = newFormIndex + 1;

          attachProductChangeListeners();
      });

      document.querySelectorAll(".delete-row").forEach((btn) => {
          btn.addEventListener("click", function () {
              const row = this.closest("tr");
              const delCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
              const delHidden = row.querySelector('input[type="hidden"][name$="-DELETE"]');
              if (delCheckbox) delCheckbox.checked = true;
              if (delHidden) delHidden.value = "on";
              row.style.display = "none";
          });
      });
  });

  function attachProductChangeListeners() {
      document.querySelectorAll('select[name^="items-"][name$="-product"]:not([data-listener-attached])').forEach(select => {
          select.setAttribute('data-listener-attached', 'true');

          select.addEventListener('change', function() {
              const productId = this.value;
              const row = this.closest('tr');
              if (!productId) return;

              const url = `/templates/products/${productId}/data`;
              fetch(url, { method: 'GET' })
                  .then(res => res.json())
                  .then(data => {
                      const netInput = row.querySelector('input[name$="-net_price"]');
                      const taxInput = row.querySelector('input[name$="-tax_rate"]');
                      if (netInput) netInput.value = data.net_price;
                      if (taxInput) taxInput.value = data.tax_rate;
                  })
                  .catch(err => {
                      console.error('Błąd pobierania danych produktu:', err);
                  });
          });
      });
  }

  document.addEventListener("DOMContentLoaded", attachProductChangeListeners);
</script>

{% endblock %}
