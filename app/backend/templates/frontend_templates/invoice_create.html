{% extends "frontend_templates/base.html" %}

{% block title %}Dodaj Fakturę{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h2 class="text-3xl font-bold">Faktury</h2>
  <a href="{% url 'tmp_invoices' %}" class="btn btn-error btn-md shadow-md">
    Wróć do listy faktur
  </a>
</div>

<div class="card bg-base-100 shadow-lg border border-base-300 rounded-box p-6">
  <h2 class="text-2xl font-bold mb-4">Dodaj nową fakturę</h2>
  <form method="POST" class="space-y-4">
    {% csrf_token %}
    {{ form.as_table }}

    {{ item_formset.management_form }}
    <table class="table w-full">
      <thead>
        <tr>
          <th>Produkt</th>
          <th>Ilość</th>
          <th>Cena netto</th>
          <th>VAT</th>
          <th>Usuń</th>
        </tr>
      </thead>
      <tbody id="items-table">
        {% for form in item_formset %}
        <tr class="item-form">
          <td>{{ form.product }}</td>
          <td>{{ form.quantity }}</td>
          <td>{{ form.net_price }}</td>
          <td>{{ form.tax_rate }}</td>
          <td>
            {% if form.instance.pk %}
              {{ form.DELETE }}
            {% else %}
              <button type="button" class="btn btn-sm btn-error delete-row">
                Usuń
              </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button"
      id="add-row"
      class="btn btn-outline btn-primary mt-4">
      Dodaj pozycję
    </button>
    <button type="submit" class="btn btn-primary">Zapisz fakturę</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addRowBtn = document.getElementById("add-row");
    const itemsTable = document.getElementById("items-table");

    // Management form values
    const totalFormsInput = document.getElementById("id_items-TOTAL_FORMS");

    addRowBtn.addEventListener("click", function () {
        const currentForms = parseInt(totalFormsInput.value);
        const newFormIndex = currentForms;

        // Pobierz pierwszy formularz jako wzór
        const emptyForm = document.querySelector(".item-form").cloneNode(true);

        // Wyczyść pola
        emptyForm.querySelectorAll("input, select").forEach((field) => {
            // podmień index (form-0 → form-1 itd.)
            const name = field.getAttribute("name").replace(
                /-(\d+)-/,
                `-${newFormIndex}-`
            );
            const id = field.getAttribute("id").replace(
                /_(\d+)_/,
                `_${newFormIndex}_`
            );
            field.setAttribute("name", name);
            field.setAttribute("id", id);

            // wyczyść wartości
            if (field.tagName === "SELECT") {
                field.selectedIndex = 0;
            } else {
                field.value = "";
            }
        });

        // Dodaj przycisk usuń
        emptyForm.querySelector(".delete-row").addEventListener("click", function () {
            this.closest("tr").remove();
        });

        // Dodaj nowy formularz do tabeli
        itemsTable.appendChild(emptyForm);

        // Zwiększ TOTAL_FORMS
        totalFormsInput.value = newFormIndex + 1;
    });

    // Obsługa usuwania dla istniejących przycisków
    document.querySelectorAll(".delete-row").forEach((btn) => {
        btn.addEventListener("click", function () {
            this.closest("tr").remove();
        });
    });
});

function attachProductChangeListeners() {
    document.querySelectorAll('select[name$="-product"]').forEach(select => {
        select.addEventListener('change', function() {
            const productId = this.value;
            const row = this.closest('tr');

            if (!productId) return;

            const url = `/templates/products/${productId}/data`;

            fetch(url, { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    const netInput = row.querySelector('input[name$="-net_price"]');
                    const taxInput = row.querySelector('select[name$="-tax_rate"]');

                    if (netInput) netInput.value = data.net_price;
                    if (taxInput) taxInput.value = data.tax_rate;
                });
        });
    });
}

// Wywołaj przy ładowaniu strony
attachProductChangeListeners();

// Przy dynamicznym dodaniu nowego wiersza też trzeba przypiąć listener
document.getElementById('add-row').addEventListener('click', function() {
    setTimeout(attachProductChangeListeners, 50); // drobne opóźnienie, żeby elementy zdążyły się dodać
});
</script>

{% endblock %}
